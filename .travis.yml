language: node_js
node_js: [
    # check Latest
    12,
    # check LTS
    10,
    # check against oldest supported
    8,
  ]
# this has to be used, otherwise it executes the tests twice (because of "default build script")
script: |
  npm run mocha
  if [ $? -ne 0 ]; then exit $?; fi # this is added because sometimes it fails and exists with 0 in travis
  if [ $TRAVIS_NODE_VERSION == "12" ]; then npm run coverage; fi
stages:
  - compile
  - test
  - deploy
jobs:
  include:
    - name: 'Test Compile Ability'
      stage: compile
      node_js: 10 # use version 10, because that speeds up the task, because travis's default is v10
      script: |
        (npm audit || exit 0)
        npm run buildtests # build tests too to check if errors from tsc are present
    - name: 'Deploy to NPM'
      stage: deploy
      if: tag IS present
      script: skip
      deploy:
        provider: npm
        email: $DEPLOY_NPM_EMAIL
        tag: latest
        skip_cleanup: true
        api_key: $DEPLOY_NPM_KEY
        on:
          tags: true
    - name: 'Deploy to GitHub Pages'
      stage: deploy
      if: branch = master # i know this redunant, but it is needed otherwise the test will always create a deploy of this
      script: npm run travis-docs
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_GH_PAGES
        keep_history: true
        target_branch: gh-pages # i know this the default, but just to be sure
        on:
          branch:
            - master
# TODO: make a deploy rolling-release npm deployment (branch "unstable"?)
